I")*<p><img src="/images/aqara-curtain-repair/aqara_curtain_logo.jpg" alt="_config.yml" /> 
Программный ремонт устройства с очисткой PDM и перепрошивкой.</p>

<p>Из-за бага в оригинальной прошивке, существует вероятность получить неработоспособный прибор при попытке переподключить его к zigbee сети.</p>

<p>Из-за неккоретных значений в PDM, электропривод не инициирует процедуру сопряжения с zigbee сетью, хотя присоединение разрешено и емкость сети позволяет принимать новые устройства. При этом синий светодиод на электроприводе индицирует процесс поиска сети в течении отведенного для этого врмени.</p>

<p>Если проанализировать трафик захваченный сниффером, то видно что устройство рассылает <em>Beacon Request</em>, получает ответ в котором <em>Association Permit = True</em>, <em>Router Capacity = True</em>, <em>End Device Capacity = True</em>, но игнорирует его и через несколько секунд отправляет <em>Beacon Request</em> снова.</p>

<p><img src="/images/aqara-curtain-repair/aqara_curtain_sniffer.png" alt="_config.yml" /></p>

<p>Для того что бы вернуть устройство в рабочий вид, необходимо очистить EEPROM в контроллере JN5169. Из-за установленного Lock-бита , который не позволяет получить доступ к EEPROM из бутлоадера, нужно в начале загрузить прошивку которая очистит EEPROM “изнутри” и только после этого можно записывать рабочую прошивку электропривода.</p>

<h4 id="шаг-1">Шаг 1</h4>
<p>Извлечь плату с контроллером, отсоеденив её от устройства.</p>

<h4 id="шаг-2">Шаг 2</h4>
<p>В соответсвии с распиновкой подключить UART преобразователь с уровнем сигнала TX–  +3.3 вольта. Оптимально использовать USB-UART преобразователь с источником на 3.3 вольта для того что бы запитать плату.</p>

<p>Сигнал /BOOT необходимо подключить к GND. Учитывайте что на определенных шагах этот сигнал должен быть отключен от GND.</p>

<p>GND – GND<br />
+3.3V – +3.3V<br />
Rx – TX<br />
TX – RX<br />
RST – nc</p>

<p><img src="/images/aqara-curtain-repair/aqara_curtain_pinouts.png" alt="_config.yml" /></p>

<h4 id="шаг-3">Шаг 3</h4>
<p><a href="/images/aqara-curtain-repair/doc/lumi_curtain_rep_files.zip">Скачать архив</a>. Он содержит утилиту <a href="https://www.nxp.com/pages/jn516x-zigbee-home-automation:ZIGBEE-HOME-AUTOMATION">JN51xx Production Flash Programmer</a>, <a href="https://github.com/re-engr/zigbee_firmware/tree/main/aqara/curtain">прошивки</a> и bat-файлы для запуска прошивальщика.</p>

<h4 id="шаг-4">Шаг 4</h4>
<p>Подключить UART преобразователь к компьютеру.<br />
Подать питание на плату электропривода, если используется внешний БП.
В файле prog_erase.bat указать COM-порт к которому подключен преобразователь (в оригинальном файле указан COM5). Запустить файл. 
Либо запустить прошивальщик командой</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JN51xxProgrammer.exe -V 1 -s COM5 -P 115200 -f lumi_curtain_erase_pdm_v1.bin
</code></pre></div></div>

<h3 id="новые-возможности">Новые возможности</h3>
<p>Восстанавливая схему, обнаружил несколько интересных особенностей устройства о которых ранее не знал:</p>
<ol>
  <li>
    <p>Широкий диапазон питающего напряжение (от 15 вольт). Я провел эксперименты с источником питания 24В постоянного тока. 
 N - плюс, L - общий. Устройство уверенно запускается. Вторичные напряжения составляют 5.2В и 3.3В. <br />
 В момент переключения реле (для поляризованного реле это единственный момент для потребления тока) нет провала вторичных напряжений. <br />
 Надо еще провести климатические испытания, особенно при минусовой температуре. Сфера применения этого устройства, в оригинальном виде, расширяется. Вот только напряжение и ток измеряются некорректно.</p>
  </li>
  <li>
    <p>Входы для кнопок S1 и S2 не имеют аппаратной ‘заточки’ быть только входами. В альтернативной прошивке их можно использовать как дискретные выходы, PWM, а при небольшой аппаратной доработке — как ЦАП.</p>
  </li>
  <li>
    <p>JN5169 можно прошить через разъем J6 на плате с реле. Это удобнее чем через разъем JP2 на плате процессора. К тому же на J6 выведены сигналы для взаимодействия с PL7211.</p>
  </li>
  <li>
    <p>PL7211 имеет ряд незадействованных GPIO. Я еще не вникал в особенности работы с этой микросхемой, но вероятно этими GPIO можно рулить из JN5169. Это так же расширяет функционал для альтернативной прошивки.</p>
  </li>
</ol>

<p>Так же на <a href="#sch">схеме</a> видно как организована измерительная часть тока/напряжения и для чего нужна красная перемычка. <br />
Некоторые элементы на схеме имеют серый фон. Это значит что они небыли смонтированы на плате. Возможно тип этих компонентов опознан некорректно.</p>

<p>Интересна надпись <strong><em>Frank&amp;Will</em></strong> на слое Top. Похоже на пасхалку. Возможно это как-то связано с <a href="https://fr.wikipedia.org/wiki/Frank-Will">этим человеком</a>.</p>
<h3 id="стек-слоёв">Стек слоёв</h3>

<p>Плата двухслойная. Толщина платы 1.5 мм. Ниже представлены сканы каждого слоя расположенных ‘на просвет’ (слой bottom отзеркален).</p>

<ul>
  <li><a href="#lay0">Top components</a>;</li>
  <li><a href="#lay1">Top mask, silk</a>;</li>
  <li><a href="#lay2">Top</a>;</li>
  <li><a href="#lay3">Bottom</a>;</li>
  <li><a href="#lay4">Bottom mask</a>;</li>
  <li><a href="#lay5">Bottom components</a>;
<a name="lay0"></a></li>
</ul>

<p><a href="/images/aqara-relay-part2/layer/0_top_comp.jpg"><img src="/images/aqara-relay-part2/layer/0_top_comp.jpg" alt="_config.yml" /></a> Top components.
<a name="lay1"></a></p>

<hr />

<p><a href="/images/aqara-relay-part2/layer/1_top_silk.jpg"><img src="/images/aqara-relay-part2/layer/1_top_silk.jpg" alt="_config.yml" /></a> Top mask, silk.
<a name="lay2"></a></p>

<hr />

<p><a href="/images/aqara-relay-part2/layer/2_top_cup.jpg"><img src="/images/aqara-relay-part2/layer/2_top_cup.jpg" alt="_config.yml" /></a> Top.
<a name="lay3"></a></p>

<hr />

<p><a href="/images/aqara-relay-part2/layer/3_bot_cup.jpg"><img src="/images/aqara-relay-part2/layer/3_bot_cup.jpg" alt="_config.yml" /></a> Bottom.
<a name="lay4"></a></p>

<hr />

<p><a href="/images/aqara-relay-part2/layer/4_bot_silk.jpg"><img src="/images/aqara-relay-part2/layer/4_bot_silk.jpg" alt="_config.yml" /></a> Bottom mask, silk.
<a name="lay5"></a></p>

<hr />

<p><a href="/images/aqara-relay-part2/layer/5_bot_comp.jpg"><img src="/images/aqara-relay-part2/layer/5_bot_comp.jpg" alt="_config.yml" /></a> Bottom components.
<a name="lay6"></a></p>

<h3 id="схема">Схема</h3>
<p><a name="sch"></a>
<a href="/images/aqara-relay-part2/aqara_relay_sch_pwr_v1.pdf">В формате pdf</a>
<a href="/images/aqara-relay-part2/aqara_relay_sch_pwr_v1.png"><img src="/images/aqara-relay-part2/aqara_relay_sch_pwr_v1.jpg" alt="_config.yml" /></a>
Схема.</p>

<hr />

<p><a href="/images/aqara-relay-part2/top_assembly.jpg"><img src="/images/aqara-relay-part2/top_assembly.jpg" alt="_config.yml" /></a>
Сборочный чертеж. Сторона top.</p>

<hr />

<p><a href="/images/aqara-relay-part2/bot_assembly.jpg"><img src="/images/aqara-relay-part2/bot_assembly.jpg" alt="_config.yml" /></a>
Сборочный чертеж. Сторона bottom.</p>
<h3 id="остальная-документация">Остальная документация</h3>
<ul>
  <li><a href="/images/aqara-relay-part2/aqara_pwr_gerber.zip">Gerber;</a></li>
  <li><a href="/images/aqara-relay-part2/bom_aqara_relay_pwr1.pdf">BOM;</a></li>
  <li><a href="/images/aqara-relay-part2/aqara-relay-part2_all.zip">Все файлы одним архивом;</a></li>
</ul>

<p>Gerber файлы я пока не проверял в железе. DRC запускал с допусками JLCPCB.</p>

<p><a href="/images/aqara-relay-part2/top_3d.jpg"><img src="/images/aqara-relay-part2/top_3d.jpg" alt="_config.yml" /></a>
Сторона top.</p>

<hr />

<p><a href="/images/aqara-relay-part2/bot_3d.jpg"><img src="/images/aqara-relay-part2/bot_3d.jpg" alt="_config.yml" /></a>
Сторона bottom.</p>
:ET