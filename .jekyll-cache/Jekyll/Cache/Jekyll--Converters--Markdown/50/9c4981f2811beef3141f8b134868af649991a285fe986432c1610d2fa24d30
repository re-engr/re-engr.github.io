I"P6<p><img src="/images/mitsubishi_mds_dh_cv_300/logo_MDS_DH_CV_300.jpg" alt="_config.yml" /></p>

<h2 id="вступление">Вступление</h2>

<p>Это источник питания сервопривода. Принесли с проблемой - при включении часто загорается код ‘E’, вместо нормальной последовательности кодов ‘AbC. Нормальный запуск происходит редко и носит случайный характер.</p>

<p>Из документации становиться понятно что код ‘E’ сигнализирует о проблеме с памятью или АЦП. 
<img src="/images/mitsubishi_mds_dh_cv_300/errE_mem_ad.jpg" alt="_config.yml" /></p>

<p>Запуская блок на столе мне удалось увидеть проблему. Примерно на 20 запусков с ошибкой ‘E’, приходится один с последовательностью кодов ‘Ab’ - это нормальный запуск. (код ‘C’ загорается когда есть связь по интерфейсу, у меня она отсуствовала). Ну что ж, проблема действительно носит плавающий характер.</p>

<p>Устройство состоит из платы управления и силовой части. Межплатное соединение осуществляется шлейфом. 
<img src="/images/mitsubishi_mds_dh_cv_300/mitsu_0.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/mitsu_1.jpg" alt="_config.yml" /></p>

<p>В качестве управляющего контроллера используется TMS320F240. Анализ сигналов на шлейфе и тщательный осмотр силовой части дали понять что внимание надо сконцентировать на плате управления (RK415D BN638A309G51).
<img src="/images/mitsubishi_mds_dh_cv_300/mitsu_cpu_a.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/mitsu_cpu_b.jpg" alt="_config.yml" /></p>

<h2 id="поиск-проблемы">Поиск проблемы</h2>

<p>Было проверено все по списку:</p>
<ul>
  <li>Целостность пайки;</li>
  <li>Качество питания;</li>
  <li>Стабильность опорного напряжения АЦП;</li>
  <li>Сигналы с ОУ и на входах АЦП (встроен в контроллер);</li>
  <li>Внешняя EEPROM;</li>
  <li>Влияние температуры;</li>
</ul>

<p>Все, кроме последнего пункта было в норме. Я заметил что при комнатной температуре бывают нормальные запуски, хоть и редко, а вот при температуре &gt; 30°C - все запуски с ошибкой. Причем удалось локализовать “термозависимый” элемент - им оказался TMS320. Заморозка чипа <a href="https://www.google.com/search?q=%D0%B0%D1%8D%D1%80%D0%BE%D0%B7%D0%BE%D0%BB%D1%8C+%D1%84%D1%80%D0%B8%D0%B7%D0%B5%D1%80&amp;source=lmns&amp;bih=676&amp;biw=1280&amp;client=safari&amp;hl=ru&amp;sa=X&amp;ved=2ahUKEwjAzOzMw4TuAhUCuCoKHTgKBNUQ_AUoAHoECAEQAA">фризером</a> подтвердила догадку - проблема либо в RAM, либо в ПЗУ. Устройство с охлажденным чипом всегда запускается корректно. По мере прогрева TMS320, начинают появляться запуски с ошибкой. Возможным был вариант нарушения соединения внутри корпуса чипа, но, как правило, охлаждение фризером микросхем с памятью, позволяет выявлять в них сбойные ячейки. Не понятно только, пока, какая именно память дает сбой.</p>

<h2 id="инструментарий">Инструментарий</h2>

<p>Процессор не имеет Lock-бита. На плате имеется разведенный JTAG, но с не запаянным разъемом (P2). Распиновка стандартная:</p>

<p><img src="/images/mitsubishi_mds_dh_cv_300/ti_jtag_14.jpg" alt="_config.yml" /></p>

<p>(Контакты 9, 11 замкнуты на стороне эмулятора)</p>

<p>Было прочитано много информации по этому процессору. Ввиду того что TMS320F240 является древним чипом, причем конкретно эта модель вынесена в отдельную категорию, поддержка со стороны софта прекратилась еще в начале 2000х годов. Многие источники информации были недоступны, некоторые приходилось просматривать через <a href="https://web.archive.org">архив интернета</a>. В конечном счете все оказалось просто. Далее я кратко и пошагово опишу процесс чтения прошивки и записи ее в новый проц.</p>

<h3 id="jtag-эмулятор">JTAG эмулятор</h3>
<p>С TMS320F240 может работать только XDS510. Вариант с LPT интерфейсом является предпочтительным. С USB интерфейсом нужно совершить больше движений по софту.</p>

<p>В процессоре может быть bootloader, в новом он точно есть, но его наличие зависит от разработчика. Его могли не оставить в рабочей версии прошивки. Я не стал тратить время на этот вариант чтения/записи прошивки.</p>

<p>Судя по отзывам, китайские клоны XDS510 подходят для работы с процом, но я не проверял.</p>

<p>Есть предложения от компании Sauris, в частности <a href="http://sauris.de/ru/zagruzki/?SECTION_ID=95&amp;ELEMENT_ID=417">SAU-XDS510-USB Lite</a>. Без проблем эмулятор добавляется в CSS и через него считывается прошивка, но для записи F240 нужно самостоятельно написать драйвер. Утилита sauflash содержит документацию как это сделать, в поставке есть несколько примеров для других процессоров.</p>

<p>Я же работал с <a href="http://www.elkos.com.ua/setdsp/sdsppp.html">SDSP-PP</a>. Является клоном XDS510PP.
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_a.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_b.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_c.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_bot.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_top.jpg" alt="_config.yml" />
<img src="/images/mitsubishi_mds_dh_cv_300/xds510_schild.jpg" alt="_config.yml" /></p>

<h3 id="чтение-прошивки">Чтение прошивки</h3>
<p><a href="https://software-dl.ti.com/dsps/forms/self_cert_export.html?prod_no=CCS_3.3.83.20_Platinum.zip&amp;ref_url=https://software-dl.ti.com/dsps/dsps_public_sw/sdo_ccstudio/CCSv3/CCS_3_3/">Code Composer Studio version 3.3</a> - это последняя вресия поддерживающая чип TMS320F240. CCS нужна только для получения прошивки из чипа.
Сохранять в формате COFF (расширение файла *.out). Пошаговая инструкция по сохранению была выложена на форуме ti.com[3].</p>

<p>А теперь главный вопрос, что же происходит в памяти при различных температурах? Я слил прошивку с горячего и холодного процессора (по несколько десятков раз) и получил 2 отличающихся файла. Адреса 0x4 и 0x5 относятся к заголовку файла в формате которого сохранена прошивка, по этому на это не обращайте внимание, а вот данные по адресу 0x1C2A - это содержимое прошивки. Видно что в байте по этому адресу первый бит поплыл. Правильное его состояние - 0.<br />
<img src="/images/mitsubishi_mds_dh_cv_300/diff_fw_f240.png" alt="_config.yml" /></p>

<h3 id="запись-прошивки">Запись прошивки</h3>
<p>Ввиду того что такой же новый процессор был доступен для заказа, я не стал экспериментировать с перезаписью старого. Допускаю что после перезаписи он бы успешно продолжил работу.</p>

<p>Запись прошивки существенно отличается от её чтения, даже без учета того что это противоположные по логике операции. Как было указано выше, для чтения нужен только JTAG эмулятор и CCS 3.3. Причем в CCS уже есть нужный пункт меню, достатоно нажать 1 кнопку.</p>

<p>Для записи нужно загрузить в RAM, через JTAG, программу которая бы выполняла команды по программированию FLASH памяти. 
Ввиду того что памяти мало, программма разбивается на блоки:</p>
<ul>
  <li>Очистка памяти;</li>
  <li>Стирание памяти;</li>
  <li>Запись данных во FLASH;</li>
</ul>

<p>Очистка памяти и стирание памяти - это различные операции:) В одной из статей какого-то журнала указывалось что FLASH память перед операцией стирания (перевод всех байт в FF) нужно обязательно очистить (все байты в 00), иначе если стереть уже стертую память, её можно повредить. Так что неудивительно что память со временем крошится.</p>

<p>Программа поддерживающая TMS320F240 - [PRG2xx DOS Command Line] Utility(https://secureservercdn.net/198.71.233.107/y4s.7d5.myftpupload.com/wp-content/uploads/files/drv/SetupPRG2xx_v332.zip)
Для работы с ней потребуется Windows XP или что-то постарше. Это вариант для LPT программатора.</p>

<p>Устанавливается софт. Настраивается программатор, сохраняются настройки. Далее распаковать архив Algos/f240_02Jan2001.zip. 
Я заменил оригинальный файл L16K0.OUT на свой, прочитанный из холодного проца. Последовательно запустить *.bat файлы:</p>
<ol>
  <li>BC0.BAT</li>
  <li>BE0.BAT</li>
  <li>BP16K.BAT</li>
</ol>

<p>Верификацию сделал через чтение посредством CCS. Все.</p>

<p>Если программатор USB, то нужно дейтствовать по <a href="http://spectrumdigital.com/sdflash-faq/#1.4">этой инструкции</a>. Здесь уже другой софт - SDFlash.</p>

<h2 id="разное">Разное</h2>

<p>Если подавать питание (5В) только на плату с процессором, без силовой части, то на индикаторе отображается символ “A”. Это происходит на битой прошивке и на рабочей.</p>

<p>Помимо трех фаз на входные силовые клемы, нужно завести две фазы на питание самого устройства. 
<img src="/images/mitsubishi_mds_dh_cv_300/power_input.png" alt="_config.yml" /></p>
<h3 id="ссылки">Ссылки:</h3>

<ol>
  <li><a href="https://e2e.ti.com/support/microcontrollers/c2000/f/171/t/106074">TMS320F243 Flash programming problems</a></li>
  <li><a href="https://e2e.ti.com/support/microcontrollers/c2000/f/171/t/110179">serial flash programming LF2407A</a></li>
  <li><a href="https://e2e.ti.com/support/microcontrollers/c2000/f/171/t/712791">TMS320F240: How to download a .hex file to TMS320F241FNA</a></li>
  <li><a href="https://e2e.ti.com/support/microcontrollers/c2000/f/171/t/857081">CCS/TMS320F240: Unable to download file to TMS320F240 DSP</a></li>
  <li><a href="https://igorkov.org/cpldexp">Эксперименты с Xilinx XC9572</a></li>
  <li><a href="https://dl.mitsubishielectric.com/dl/fa/document/manual/cnc/ib1500025/ib1500025engh.pdf">MDS-D/DH series instruction manual</a></li>
</ol>

:ET