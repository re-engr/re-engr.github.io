---
layout: post
title: ZigBee реле ZR2A
---
![_config.yml]({{ site.baseurl }}/images/zr2a/zr2a_logo_small.png)

 - [Назначение](#start)  
 - [Возможности](#capabilities)  
 - [Управление. Индикация](#connect_control_indication)
 - [Схема подключения](#connect_diagram)
 - [Аквастоп на ZR2A](#water_stop)
 - [Фотографии ZR2A](#photo_zr2a)
 - [Документация для сборки](#src_zr2a)

<a name="start"></a>
## Назначение
Устройство, в первую очередь, будет интересно пользователям системы Xiaomi Mi Home. Скудный выбор из того, что предлагают разработчики, заставляет михомовцев переделывать покупные изделия под свои задачи. Если с датчиками и сенсорами дела обстоят более-менее нормально, то с исполнительными устройствами совсем беда. Долгое время единственным доступным устройством для воздействия на окружающий мир была розетка ZNCZ02LM, потом начали появляться всякие выключатели с нулем, без нуля и, в один прекрасный момент, в продаже появилось aqara реле LLKZMK11LM. Оно привлекло внимание выведенными на клеммники контактами реле, наличием входов, измерение питающего напряжения и тока через контакты реле. Но все это дополнялось своими собственными причудами и недоработками. Чего только стоит режим работы входов для локального управления состоянием реле! У этого управления есть два режима: 
 
 * Триггерный (импульсный) режим. Смена состояния реле происходит по нажатию. Подходит для клавиш без фиксации;
 * Режим повторения. Клавиша в положение ВКЛ - реле замкнуто, в положение ВЫКЛ - разомкнуто. Подходит для обычных рубильников;

Так вот, триггерный режим работы создавался либо под специальные клавиши, либо он недоработан, либо китайцы привыкли работать в таком темпе. Импульс от клавиши должен находиться в пределах 51-149 мс! Если задержался - привет от режима повторения, если ты был слишком быстр - устройство тебя не поймет. 

Есть задачи, где от устройства управления требуется наличие сухого контакта, а в случаи с LLKZMK11LM, это может быть достигнуто либо доработкой схемы (резать дорожки), либо использования внешнего промежуточного реле.   

В оригинальном виде LLKZMK11LM не подходило под мои требования, в доработанном - частично. В связи с этим было принято решение разработать новое устройство - ZR2A, взяв за основу LLKZMK11LM.

<a name="capabilities"></a>
## Возможности 
ZR2A позаимствовал от оригинала всего две вещи: прошивку и вследствие этого - микроконтроллер. По этому со стороны zigbee сети ZR2A будет выглядеть для Mi Home родным девайсом. Но схемотехника устройств существенно отличается. В таблице ниже представлено сравнение по основным характеристикам.

|     Параметр     |  ZR2A |  LLKZMK11LM  |
| --------------------------------- | ----- | ------------- |
| Поддержка в Mi Home      |  +  |      +   |
| Питание AC220V      |  +  |      +   |
| Питание 5V       |  +  |      -    |
| Колличество выходов (реле)  | 2(НО) |  2  |
| "Сухие" контакты реле    |  + |   -   |
| Крепление на DIN рейку    |  +  |       -    |
| Индикация состояния реле    | + |  -  |
| Контроль напряжения и тока  | - |  +  |
| Гальванически развязанный БП  | + |  -  |
| Дискретные входы     | 2 |  2  |
| Максимальный ток реле (AC1)  |  10A  |  16A  |     
| Перемычка из красного провода  |   - |  +  |
| Контроль внутренней температуры  | + |  +  |
| Переход в аварию по перегреву  | + |  +  |
| Interlock  | + |  +  |
| Антенна  | внутр./внеш. |  внешн.  |

Краткое описание некоторых пунктов сравнения:

### Поддержка в Mi Home
ZR2A опознается в Mi Home как LLKZMK11LM. Версия ПО 09-20-2018. 
Так же ZR2A поддерживается альтернативными системами где есть поддержка LLKZMK11LM.
Отличие только в нулевых значениях power, voltage, enegry для ZR2A.
![_config.yml]({{ site.baseurl }}/images/zr2a/zr2a_z2m.png)

### Питание 5V
ZR2A может питаться от внешнего напряжения 5V. Ток потребления при разомкнутых реле - 20 мА, при замкнутых - 110 мА.

У LLKZMK11LM такая возможность есть только после доработки. 

### Количество выходов (реле)
Выходы - это каналы реле. В ZR2A используется 2 реле с контактами типа 1A (одна группа, нормально открытые). Каналы между собой не имеют связи, поэтому устройство можно применять в схемах, где необходимо коммутировать различные напряжения.

LLKZMK11LM так же имеет два канала реле, но они связаны между собой и имеют гальваническую связь с источником питания(220V). Этот вопрос решается доработкой или внешними реле.

### Крепление на DIN рейку
ZR2A имеет низкопрофильный корпус размером 2M и креплением на DIN рейку. Корпус позволяет задействовать 10 контактов клеммников.  

Размеры корпуса (ДxШxВ), мм : 86x38x38;
### Индикация состояния реле
На лицевой стороне корпуса ZR2A имеется светодиодная индикация состояния каждого реле. 
Светящийся светодиод говорит о замкнутых контактах реле.

### Контроль напряжения и тока
В LLKZMK11LM используется микросхема PL7211 реализующая измерение питающего напряжения и измерение общего тока через реле. Для контроля тока используется шунт. 

В ZR2A эти возможности отсутствуют. 

### Гальванически развязанный БП
В LLKZMK11LM применена схема преобразования питающего напряжения 220 вольт во вторичное напряжения 5 вольт без использования развязывающего трансформатора. С одной стороны имеем компактность и относительную дешевизну, а с другой - гальваническую связь с сетевым напряжением на всех выводах и компонентах устройства, в том числе и на антенне. 

В ZR2A используется AC/DC преобразователь с развязывающим трансформатором. Вторичные напряжения не имеют гальванической связи с 220V, но все равно это не избавляет от необходимости соблюдать технику безопасности при эксплуатации устройства.

### Дискретные входы
В стандартной схеме включение LLKZMK11LM активным входным сигналом является подача фазы 220V. 

В ZR2A ко входам подключаются переключатели с "сухим" контактом (кнопки, контакты реле, герконы) или выходы "открытый коллектор". Входы имеют внутреннюю подтяжку к +5V и активным уровням для них является замыкание входа на землю.

### Максимальный ток реле (AC1)
Значение тока через контакты реле для ZR2A и LLKZMK11LM, да и практических для всех остальных реле, указана для категории тока AC1 (резистивная или слабоиндуктивная нагрузка переменного тока). Для индуктивной нагрузки(эл. двигатели, низкокачественные импульсные блоки питания) руководствуйтесь правилом делить ток реле на 2. Если вам необходимо коммутировать мощную, индуктивную нагрузку, используйте предназначенные для этого промежуточные реле и контакторы. 

### Контроль внутренней температуры
Измерение температуры производится для аварийного отключения нагрузки при перегреве внутренних компонентов устройства, что может быть вызвано неисправностью реле, клеммников или эксплуатация устройства в запредельных режимах и условиях. Датчик температуры установлен внутри микроконтроллера JN5169, поэтому значение температуры всегда будет выше, чем температура окружающей среды. Это связано с тепловыделением ядра микроконтроллера. 

### Переход в аварию по перегреву
При превышении температуры выше 65 градусов, срабатывает защитный механизм и реле размыкают контакты. Индикация режима производится миганием красного светодиода. Переход в нормальный режим работы происходит при достижении температуры 35 градусов, либо перезапуском устройства по питанию. К сожалению, в MiHome пока не реализовано оповещение пользователя о переходе в аварийный режим. 

Аварийный режим также активизируется при превышении допустимого тока через реле. Подходит только для LLKZMK11LM. В ZR2A отсутствует измерение тока.

### Антенна
В ZR2A антенна может быть расположена внутри или снаружи корпуса. Для наружнего расположения в верхней части корпуса предусмотрено отверстие для вывода фидера.   
Внутреннее размещение антенны делает устройство более компактным, но при этом значительно уменьшается дальность связи.   
Выбор размещения антенны зависит от условий использования устройства.

<a name="connect_control_indication"></a>
## Управление. Индикация

<img src="/images/zr2a/zr2a_control_led.jpg" /> 

Режим работы кнопки "Pairing/Toggle relays" и двухцветного светодиода "Net status" в ZR2A полностью совпадает с режимами работы кнопки и светодиода в LLKZMK11LM. 

#### Кнопка Pairing/Toggle relays
 * **Удерживание нажатой более 5 секунд** - выйти из сети / активировать функцию присоединения к сети;
 * **Короткое нажатие в нормальном режиме** - переключить оба реле в противоположное состояние;
 * **Короткое нажатие в аварийном режиме**  - отключить аварийный режим;

#### Входы In 0, 1
Оба входа работают идентично. Вход "In 0" связан в "Relay 0", вход "In 1" связан с "Relay 1".
Входы имеют подтяжку к +5V через резистор 10к. Активный уровень - низкий. 

По сравнению с LLKZMK11LM, в ZR2A режим работы входов претерпел некоторые изменения:

 * **Триггерный (импульсный) режим.** Длительность нажатия (импульса) может быть в пределах 50 - 500 мс. (у LLKZMK11LM 51-149 мс);
 * **Режим повторения.** Активизируется при длительном нажатии на клавишу (более 500 мс). Если реле было разомкнуто командой по zigbee, а в это время на соответствующем входе был низкий уровень (клавиша нажата), то отжатие клавиши не приведет к повторному замыканию реле, как это было у LLKZMK11LM;
 
#### Индикация

 * Светящиеся зеленые светодиоды **Relay 0**, **Relay 1** соответствуют замкнутым контактам реле;
 * Двухцветный светодиод **Net status** имеет несколько режимов работы: 
	* **Синий - ровное свечение** - устройство подключено к zigbee сети и имеет стабильное соединение с координатором;
	* **Синий - мигание с частотой 1 Гц** - устройство не  подключено к zigbee сети, либо нет связи с координатором;
	* **Синий - мигание с частотой 3.5 Гц** - устройство в режиме Pairing. Максимальная длительность поиска zigbee сети составляет 20 секунд;
	* **Красный - мигание с частотой 3.5 Гц** (так же накладывается синий светодиод со своим режимом работы)- устройство находится в аварийном режиме. Реле разомкнуты; 

<a name="connect_diagram"></a>
## Схема подключения
Назначение выводов ZR2A можно увидеть на наклейке расположенной на передней части устройства.  
<img src="/images/zr2a/zr2a_pinouts.png" />   

Ниже приведены несколько примеров схем включения. Виды нагрузки и источников входных сигналов не ограничиваются представленными в примерах.

#### Схема 1
Питание осуществляется от 220 вольт. Канал Relay 0 осуществляет управление двигателем переменного тока питающегося от 220 вольт. Канал Relay 1 осуществляет управление слаботочной нагрузкой в виде лампочки, для которой напряжение питания берется с клеммы +5V. Эта клемма связана внутри устройства с выходом преобразователя AC/DC. Максимальный ток преобразователя, по паспорту, 600 мА. Из расчета потребления устройства и запаса, для питания внешних потребителей остается 300 мА. Рекомендуется не превышать этот предел. 
Ко входам подключены кнопки.
<img src="/images/zr2a/sch1_220.png" />  

#### Схема 2
Питание осуществляется от источника 5V с выходным током не менее 300 мА. В качестве нагрузки используется двигатель переменного тока и лампочка питающиеся от 220 вольт. В качестве источников входных сигналов используется выход любого другого устройства с открытым коллектором (датчик освещенности, движения, сигнализация) (канал In 0) и геркон (канал In 1).
<img src="/images/zr2a/sch2_5v.png" />  

<a name="water_stop"></a>
## "Аквастоп" на ZR2A
Это одно из возможных применений устройства. В системе используется шаровый [кран от системы "Аквасторож"](https://xn--80aafrr0aaphk.xn--p1ai/product/elektrokran-akvastorozh-ekspert-15-mm/). Кран имеет 2 вывода. Положение крана определяется полярностью напряжения на его выводах. Для решения задачи смены полярности есть 2 пути: использовать два внешних реле и один источник питания, либо использовать встроенные реле ZR2A, но два источника питания. Для упрощения схемы, я выбрал второй путь.   
Важным моментом является исключение возможности перевести оба реле в закнутое состояние. По схеме видно, что при замкнутых контактах реле произойдет замыкание выводов одного блока питания, на выводы другого блока питания с противоположной полярностью. Что бы этого не произошло, необходимо активировать режим interlock. 
Сделать это можно через приложение MiHome. На видео ниже все показано.   
Режим interlock работает до тех пор, пока устройство не будет удалено из сети координатором, либо через длительное удерживание кнопки. Конечно, схему можно доработать, например поставив токоограничительные резисторы, но при должной внимательности при первоначальной настройке, схему можно эксплуатировать и в таком виде.  Так же не забывайте что кнопка toggle relay переводит реле в противоположное состояние вне зависимости от режима interlock. 

<img src="/images/zr2a/zr2a_water_sch.png" />  

Для просмотра видео, кликните на картинку.
[![Видео. Защита от затопления.](https://img.youtube.com/vi/b0yw0Vj8egU/0.jpg)](https://www.youtube.com/watch?v=b0yw0Vj8egU "Видео. Защита от затопления.")

<a name="photo_zr2a"></a>
## Фотографии ZR2A
[Фотографии внешнего вида и внутренней компоновки ZR2A.](https://photos.app.goo.gl/QLpe1RZQf9Uj6x3J8)

<a name="src_zr2a"></a>
## Документация для сборки
Все находится [здесь](https://github.com/re-engr/zigbee_zr2a)

[Обновление прошивки через Aqara Home](https://www.youtube.com/watch?v=LQyfK4ZzG4U)

По всем вопросам пишите на почту или в Telegram указанные в [About]({{ site.baseurl }}/about/)
