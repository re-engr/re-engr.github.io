---
layout: post
title: Ремонт Mitsubishi MDS-R-V2-4040. MDS-R series Offline Monitor
---
![_config.yml]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/mitsubishi-mds-r-v2-4040.png)
Сервопривод остановился с ошибками 12-53. 

 * **Alarm No. 12: Memory error 1: A CPU error or an internal memory error was detected during the power ON self-check.**
 * **Alarm No. 53: Excessive error 2: A difference between the actual and theoretical motor positions during servo OFF exceeded the setting
value.**  

В данном случае ошибка 53 была следствием ошибки 12. Для поиска и устранения неисправности пришлось прибегнуть к исследованию прошивки. Аппарат построен на TMS320C6712D. Прошивка храниться во внешней ПЗУ S29AL004D70TFI02, для хранения настроек используется EEPROM AT25020.

Неисправность была устранена. Попутно, в ходе реверс-инжиниринга исполняемого кода, был обнаружен [Offline Monitor]({{ site.baseurl }}/debug-monitor/) доступный через последовательный порт RS422 выведенный на разъем CN4. 
![_config.yml]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/cn4_rs422_mds_r_monitor.png)


Статья состоит из трех разделов: 
 * [Возможности программы Offline Monitor](#part_monitor);
 * [Устранение неисправности](#part_fix);
 * [Некоторые детали которые могут пригодиться тем кто будет исследовать контроллеры из серии Mitsubishi MDS-R](#part_th);

## Monitor {#part_monitor}

Монитор позволяет читать/писать все доступные области памяти (flash/ram/eeprom/bus_io), получать диагностические сообщения, запускать внутренние тесты. Поддерживает 38 команд. Распиновка разъема для подключения приведена [здесь]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/cn4_rs422_mds_r_monitor.png). Для входа в режим монитора достаточно передать любой символ. При успешном переходе в этот режим, на 7seg индикаторе отобразиться надпись "On". 

Для некоторых команд привожу описание, примеры использования и вывод. 

| Команда       | Описание                                                             |
| ------------- |
| [mm](#mm)     | Пример вывода                                                        |
| mm.w          |
| mm.h          |
| mm.b          |
| [md](#md)     | Дамп памяти. >md 80010000 1000                                       |
| md.w          |
| md.h          |
| md.b          |
| [mf](#mf)     | Зафилить память                                                      |
| mf.w          |
| mf.h          |
| mf.b          |
| mv            |
| [sum](#sum)   | Пример вывода                                                        |
| [rst](#rst)   | Перезапустить устройство                                             |
| ?#            |
| ?             |
| .             |
| fe            |
| [fw](#fw)     | Записать данные (вероятно во flash)                                  |
| [fdv](#fdv)   | ID производителя и оборудования                                      |
| [ed](#ed)     | Коды ошибок сохраненные в EEP                                        |
| [er](#er)     | Дамп eeprom                                                          |
| [ew](#ew)     | Записать в eeprom                                                    |
| [ef](#ef)     | Зафилить eeprom                                                      |
| ei            |
| [ec](#ec)     | Стереть еепром (не всю, только некоторые параметры)                  |
| em            |
| [dl](#dl)     | Пароль “Flash Memory Programing” Загрузить по X-MODEM новую прошивку |
| go            |
| led           | Проверить 7seg индикатор                                             |
| [base](#base) | Пример вывода                                                        |
| [card](#card) | Пример вывода                                                        |
| [di](#di)     | Digital input                                                        |
| [ad](#ad)     | Analog input                                                         |
| [ver](#ver)   | Версия ПО                                                            |
| [err](#err)   | Показать наличие ошибок                                              |
| ram           |

### mm {#mm}
```
>mm
00000000 : 802A  ? 
00000002 : 0100  ? 
00000004 : 006A  ? 
00000006 : 0148  ? 
00000008 : 0362  ? M
```

### md {#md}
```
>md 865c
0000865C : 520A 4D41 4F20 0A4B - 4F52 204D 4B4F 450A           .RAM OK.ROM OK.E
0000866C : 434E 4F20 0A4B 4545 - 5250 4D4F 4F20 004B           NC OK.EEPROM OK.
0000867C : 540A 4D49 494D 474E - 5320 4154 5554 2053           .TIMMING STATUS 
0000868C : 4B4F 0000 430A 5241 - 2044 5453 5441 5355           OK...CARD STATUS

>md 01940000 100
01940000 : 0384 0000 FFFF FFFF - B19F 7EC7 FFFF FFFF           ...........~....
01940010 : 0384 0000 FFFF FFFF - D631 7ECF FFFF FFFF           ...........~....
01940020 : 0384 0000 FFFF FFFF - 1700 7ED7 FFFF FFFF           ...........~....
01940030 : 0384 0000 FFFF FFFF - 6A11 7EE0 FFFF FFFF           .........j.~....
01940040 : 0384 0000 FFFF FFFF - B6B8 7EE8 FFFF FFFF           ...........~....
01940050 : 0384 0000 FFFF FFFF - 96E8 7EF0 FFFF FFFF           ...........~....
01940060 : 0384 0000 FFFF FFFF - B370 7EF8 FFFF FFFF           ........]..~....
01940070 : 0384 0000 FFFF FFFF - CE65 7F01 FFFF FFFF           ................
01940080 : 0384 0000 FFFF FFFF - EBC2 7F09 FFFF FFFF           ................
01940090 : 0384 0000 FFFF FFFF - 158D 7F11 FFFF FFFF           ........z.......
019400A0 : 0384 0000 FFFF FFFF - 7D3F 7F1A FFFF FFFF           ........,}......
019400B0 : 0384 0000 FFFF FFFF - C476 7F22 FFFF FFFF           ........d.".....
019400C0 : 0384 0000 FFFF FFFF - B4BE 7F2A FFFF FFFF           ..........*.....
019400D0 : 0384 0000 FFFF FFFF - D173 7F32 FFFF FFFF           ........a.2.....
019400E0 : 0384 0000 FFFF FFFF - ED84 7F3B FFFF FFFF           ........q.;.....
019400F0 : 0384 0000 FFFF FFFF - 099D 7F43 FFFF FFFF           ..........C.....
```

### mf {#mf}
```
>mf a001ffa0 100 00
>md.b a001ffa0
A001FFA0 : 00 00 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00   ................
A001FFB0 : 00 00 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00   ................
A001FFC0 : 00 00 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00   ................
A001FFD0 : 00 00 00 00 00 00 00 00 - 00 00 00 00 00 00 00 00   ................
```

### sum {#sum}
```
>sum
Sum : 00000000 - FFFFFFFF = 0000
```

### rst {#rst}
```
>rst

************************************************************************
MITSUBISHI DRIVE SYSTEM
 MDS-R series Offline Monitor
 BND- 563W000-A1  (1.10)  (Apr  6 2006, 18:41:24)
 COPYRIGHT (C) 2003 MITSUBISHI ELECTRIC CORPORATION ALL RIGHTS RESERVED         
************************************************************************
Card Infomation
 NAME   : RL115-12/22(V2)
 MAC521 : OFF
 FLASH  : 0x90000000-????????[????byte) [??????????:Un known]
Digital Input
  EI1:L(400V)  EI2:L(CR Int)  EI3:L(Rsv)  EI4:L(ElcEMG)
  SW :L(0) M(1)
Analog Input
 CH Sym   min   max    pp    av
  1.IUL: 1458  1470    12  1464
  2.IVL: 1458  1468    10  1462
  3.IUM: 1457  1465     8  1460
  4.IVM: 1460  1468     8  1463
  5.STL:    0     0     0     0 [45s]
  6.STM:    0     0     0     0 [45s]
  7.THR:    0     0     0     0
  8.DIP:    0     5     5     0 [00]
System S/W: BND- 585W000-A4  (1.40)
************************************************************************
```

### fw {#fw}
```
>fw 90000000 1 2a
Program error
```

### fdv {#fdv}
```
>fdv
 Manufacture ID : 01
 Device code    : 22BA
 ```

### ed {#ed}
```
>ed
 Drive No. : 6829300 
 Ron Time  : 00016983
 MC count  : 00002387
 Maintenance
  #0 :   
  #1 :   
  #2 :   
  #3 :   
 Status    :  
 Alarm
  #0 :  50-00015232  50-00011735  00-00000000
  #1 :  50-00015232  50-00010130  00-00000000
  #2 :  50-00015232  50-00009893  00-00000000
  #3 :  50-00015232  51-00009891  00-00000000
  #4 :  50-00015232  52-00007771  00-00000000
  #5 :  50-00015232  50-00006422  00-00000000
  #6 :  52-00014310  50-00006105  00-00000000
  #7 :  52-00014310  50-00003693  00-00000000

```

### er {#er}
```
>er
00 : 36 38 32 39 33 30 30 20 20 20 20 20 20 20 20 20 
10 : 58 42 00 C1 57 42 00 C1 53 09 00 00 00 00 20 00 
20 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
30 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
40 : 80 3B 00 50 80 3B 00 50 80 3B 00 50 80 3B 00 50 
50 : 80 3B 00 50 80 3B 00 50 E6 37 00 52 E6 37 00 52 
60 : 00 31 1F 03 13 2E 00 00 00 00 00 00 00 00 00 00 
70 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
80 : D7 2D 00 50 92 27 00 50 A5 26 00 50 A3 26 00 51 
90 : 5B 1E 00 52 16 19 00 50 D9 17 00 50 6D 0E 00 50 
A0 : 00 31 0E 00 07 2E 00 00 00 00 00 00 00 00 00 00 
B0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
C0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
D0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
E0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
F0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
```
### ew {#ew}
```
>ew 0 2
>er
00 : 02 38 32 39 33 30 30 20 20 20 20 20 20 20 20 20 
10 : 58 42 00 C1 57 42 00 C1 53 09 00 00 00 00 20 00 
20 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
30 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
40 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
50 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
60 : 00 31 1F 03 13 2E 00 00 00 00 00 00 00 00 00 00 
70 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
80 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
90 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
A0 : 00 31 0E 00 07 2E 00 00 00 00 00 00 00 00 00 00 
B0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
C0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
D0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
E0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
F0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
  ```
### ef {#ef}
```
>ef 0 ff ff
>er
00 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
10 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
20 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
30 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
40 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
50 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
60 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
70 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
80 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
90 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
A0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
B0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
C0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
D0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
E0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 
F0 : FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 00 
```

### ec {#ec}
```
>ec 
y/n ? y
>
>ed
 Drive No. : 
 Ron Time  : 00000000
 MC count  : 1229539657
 Maintenance
  #0 : II
  #1 : II
  #2 : II
  #3 : II
 Status    : I
 Alarm
  #0 :  00-00000000  00-00000000  00-00000000
  #1 :  00-00000000  00-00000000  00-00000000
  #2 :  00-00000000  00-00000000  00-00000000
  #3 :  00-00000000  00-00000000  00-00000000
  #4 :  00-00000000  00-00000000  00-00000000
  #5 :  00-00000000  00-00000000  00-00000000
  #6 :  00-00000000  00-00000000  00-00000000
  #7 :  00-00000000  00-00000000  00-00000000
```

### dl {#dl}
```
>dl
password : 
* XMODEM/128(SUM) Recieving ... 
Flash Sum = 0000
```

### base {#base}
```
>base
 Base name : 45s : 45s
```

### card {#card}
```
>card
Card Infomation
 NAME   : RL115-12/22(V2)
 MAC521 : OFF
 FLASH  : 0x90000000-????????[????byte) [??????????:Un known]
```
### di {#di}
```
>di
Digital Input
  EI1:L(400V)  EI2:L(CR Int)  EI3:L(Rsv)  EI4:L(ElcEMG)
  SW :L(0) M(1)
```

### ad {#ad}
```
>ad
Analog Input
 CH Sym   min   max    pp    av
  1.IUL: 1460  1469     9  1464
  2.IVL: 1458  1468    10  1462
  3.IUM: 1455  1466    11  1460
  4.IVM: 1458  1468    10  1463
  5.STL:    0     0     0     0 [45s]
  6.STM:    0     0     0     0 [45s]
  7.THR:    0     0     0     0
  8.DIP:    0     6     6     0 [00]
```

### ver {#ver}
```
>ver
Boot   S/W: BND- 563W000-A1  (1.10)
System S/W: BND- 585W000-A4  (1.40)
```

### err {#err}
```
>err
12-53 : EEPROM ERR
00 : 36 38 32 39 33 30 30 20 20 20 20 20 20 20 20 20 
10 : 58 42 00 C1 57 42 00 C1 53 09 00 00 00 00 20 00 
20 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
30 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
40 : 80 3B 00 50 80 3B 00 50 80 3B 00 50 80 3B 00 50 
50 : 80 3B 00 50 80 3B 00 50 E6 37 00 52 E6 37 00 52 
60 : 00 31 1F 03 13 2E 00 00 00 00 00 00 00 00 00 00 
70 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
80 : D7 2D 00 50 92 27 00 50 A5 26 00 50 A3 26 00 51 
90 : 5B 1E 00 52 16 19 00 50 D9 17 00 50 6D 0E 00 50 
A0 : 00 31 0E 00 07 2E 00 00 00 00 00 00 00 00 00 00 
B0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
C0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
D0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
E0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
F0 : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

>err
RAM OK
ROM OK
ENC OK
EEPROM OK
TIMMING STATUS OK : 3.5msec COUNT ERR : 37
CARD STATUS    OK : ID:02 (exi2:0 trac:0 tin0:0 tin1:0)
```

## Неисправность {#part_fix}
Проблема заключалась в том, что контрольная сумма (далее КС) одного из параметров в eeprom была некорректной. Для данных по адресам 0x10...0x13 и 0x14...0x17 рассчитывается КС (сумма по модулю 256) и она должна быть равна 0x5A. 

Командой [er](#er) получаем дамп eeprom. Берем 8 байт с адреса 0x10. В моем случае это: ```0x58 0x42 0x00 0xC1 0x57 0x42 0x00 0xC1```.
Для первых 4 байт КС равна: ```(0x58 + 0x42 + 0x00 + 0xC1) % 0xFF = 0x5B```.
Для следующих четырех байт: ```(0x57 0x42 0x00 0xC1) % 0xFF = 0x5A```.
КС 0x5B вызывает ошибку. Я исправил первое значение так, что бы оно соответствовало второму: заменил 0x58 на 0x57. Не помню почему именно так сделал. 

Выполнить модификацию значения можно с помощью команды [ew](#ew)
```ew 10 57```. Проверяем командой [er](#er) ```10 : 0x57 0x42 0x00 0xC1 0x57 0x42 0x00 0xC1 ...```
После перезагрузки контроллера, на 7seg было рабочее значение "Ab" без каких либо ошибок. 
![_config.yml]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/mitsubishi_ab.png)  
В логах команды [err](#err) можете увидеть два вывода. Первый при некорректной КС, второй после исправления. 

## Заключение {#part_th}

Здесь можно скачать дамп [flash]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/S29AL004D70TFI02.BIN) и [eeprom]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/25020_eep_repair.BIN).

В архиве собрана различная документация и логи накопившееся за время выполнения ремонта. [Ссылка на архив]({{ site.baseurl }}/images/mitsubishi-mds-r-v2-4040/mitsubishi-MDS-R-V2-4040.zip).  
Там есть какие-то дампы участков памяти. Может пригодиться тем кто будет исследовать такой же или подобный сервопривод. 

Здесь хранятся фото устройства. [Ссылка](https://photos.app.goo.gl/pBo2FWdqYoFqTL7w7)

Если у вас остались вопросы или вы хотите предложить покопаться в подобном оборудовании - пишите в [Telegram-чат](https://t.me/reengrru)